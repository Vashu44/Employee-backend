{% extends "admin/base.html" %}

{% block title %}Leave Management{% endblock %}

{% block content %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Management</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .table th {
            border-top: none;
            font-weight: 600;
            background-color: #f8f9fa;
        }
        .badge {
            font-size: 0.75em;
        }
        .btn-group .btn {
            margin-right: 2px;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-approved { background-color: #198754; }
        .status-rejected { background-color: #dc3545; }
        .status-cancelled { background-color: #6c757d; }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            .btn-group .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="bi bi-calendar-check me-2"></i>Leave Management
                </h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#leaveModal" id="add-new-btn">
                    <i class="bi bi-plus-circle me-1"></i>Add New Application
                </button>
            </div>
            <div class="card-body">
                <!-- Filters Section -->
                <div class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select id="filter-status" class="form-select">
                                    <option value="">All Statuses</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Employee</label>
                                <input id="filter-employee-id" type="text" class="form-control" placeholder="Employee ID or Name">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">From Date</label>
                                <input id="filter-from-date" type="date" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-2">  
                            <div class="form-group">
                                <label class="form-label">To Date</label>
                                <input id="filter-to-date" type="date" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button id="clear-filters" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Cards -->
                <div class="row mb-2 sm:space-y-10">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-clock-fill fs-2 me-3"></i>
                                    <div>
                                        <h4 id="pending-count" class="mb-0">0</h4>
                                        <small>Pending</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill fs-2 me-3"></i>
                                    <div>
                                        <h4 id="approved-count" class="mb-0">0</h4>
                                        <small>Approved</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-x-circle-fill fs-2 me-3"></i>
                                    <div>
                                        <h4 id="rejected-count" class="mb-0">0</h4>
                                        <small>Rejected</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-secondary text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-calendar-x-fill fs-2 me-3"></i>
                                    <div>
                                        <h4 id="total-count" class="mb-0">0</h4>
                                        <small>Total</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Table Section -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="leave-table">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>User ID</th>
                                <th>Leave Type</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Days</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Applied</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leave-applications-body">
                            <tr>
                                <td colspan="11" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading leave applications...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Leave Application Modal -->
    <div class="modal fade" id="leaveModal" tabindex="-1" aria-labelledby="leaveModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="leaveModalLabel">Add Leave Application</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="leave-form">
                        <input type="hidden" id="leave-id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="user-id" class="form-label">User ID *</label>
                                    <input type="text" class="form-control" id="user-id" required>
                                    <div class="error-message" id="user-id-error"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="leave-type" class="form-label">Leave Type *</label>
                                    <select class="form-select" id="leave-type" required>
                                        <option value="">Select Leave Type</option>
                                        <option value="Annual">Annual Leave</option>
                                        <option value="Sick">Sick Leave</option>
                                        <option value="Personal">Personal Leave</option>
                                        <option value="Emergency">Emergency Leave</option>
                                        <option value="Maternity">Maternity Leave</option>
                                        <option value="Paternity">Paternity Leave</option>
                                        <option value="Casual">Casual Leave</option>
                                        <option value="Compassionate">Compassionate Leave</option>
                                    </select>
                                    <div class="error-message" id="leave-type-error"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start-date" class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" id="start-date" required>
                                    <div class="error-message" id="start-date-error"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end-date" class="form-label">End Date *</label>
                                    <input type="date" class="form-control" id="end-date" required>
                                    <div class="error-message" id="end-date-error"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Duration: <span id="duration-display" class="text-primary fw-bold">0 days</span></label>
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason *</label>
                            <textarea class="form-control" id="reason" rows="3" required placeholder="Please provide the reason for your leave request"></textarea>
                            <div class="error-message" id="reason-error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="comments" class="form-label">Additional Comments</label>
                            <textarea class="form-control" id="comments" rows="2" placeholder="Any additional information or comments"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="submit" form="leave-form" class="btn btn-primary" id="save-button">
                        <i class="bi bi-check-circle me-1"></i>Save Application
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">Update Leave Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="status-form">
                        <input type="hidden" id="status-leave-id">
                        <div class="mb-3">
                            <label class="form-label">Current Application Details:</label>
                            <div id="status-app-details" class="p-3 bg-light rounded">
                                <!-- Application details will be populated here -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="new-status" class="form-label">New Status *</label>
                            <select class="form-select" id="new-status" required>
                                <option value="">Select Status</option>
                                <option value="Approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="approved-by" class="form-label">Processed By *</label>
                            <input type="text" class="form-control" id="approved-by" value="HR Manager" required>
                        </div>
                        <div class="mb-3">
                            <label for="status-comments" class="form-label">Comments</label>
                            <textarea class="form-control" id="status-comments" rows="3" placeholder="Add comments about the status change"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="submit" form="status-form" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                <strong class="me-auto">Leave Management</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Message will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuration
        const API_BASE_URL = "{{ API_BASE_URL }}";
        const CURRENT_USER_ID = 1; // This should be dynamically set from your authentication system
        
        // Global variables
        let allLeaveData = [];
        let filteredData = [];
        
        // Modal instances
        const leaveModal = new bootstrap.Modal(document.getElementById('leaveModal'));
        const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
        const notificationToast = new bootstrap.Toast(document.getElementById('notification-toast'));
        
        // DOM elements
        const statusFilter = document.getElementById('filter-status');
        const employeeIdFilter = document.getElementById('filter-employee-id');
        const fromDateFilter = document.getElementById('filter-from-date');
        const toDateFilter = document.getElementById('filter-to-date');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const tableBody = document.getElementById('leave-applications-body');
        const leaveForm = document.getElementById('leave-form');
        const statusForm = document.getElementById('status-form');
        const addNewBtn = document.getElementById('add-new-btn');
        
        // Utility Functions
        function showNotification(message, type = 'success') {
            const toastEl = document.getElementById('notification-toast');
            const toastHeader = toastEl.querySelector('.toast-header i');
            const toastMessage = document.getElementById('toast-message');
            
            // Update icon and message based on type
            if (type === 'success') {
                toastHeader.className = 'bi bi-check-circle-fill text-success me-2';
            } else if (type === 'error') {
                toastHeader.className = 'bi bi-exclamation-circle-fill text-danger me-2';
            } else {
                toastHeader.className = 'bi bi-info-circle-fill text-primary me-2';
            }
            
            toastMessage.innerHTML = message;
            notificationToast.show();
        }

        function calculateDays(startDateStr, endDateStr) {
            if (!startDateStr || !endDateStr) return 0;
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            const diffTime = Math.abs(end - start);
            return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            return new Date(dateTimeStr).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getStatusBadgeClass(status) {
            const statusClasses = {
                'pending': 'bg-warning text-dark',
                'approved': 'bg-success',
                'rejected': 'bg-danger',
                'cancelled': 'bg-secondary'
            };
            return statusClasses[(status || '').toLowerCase()] || 'bg-info';
        }

        function updateStatistics(data) {
            const stats = data.reduce((acc, app) => {
                acc.total++;
                const statKey = (app.status || '').toLowerCase();
                acc[statKey] = (acc[statKey] || 0) + 1;
                return acc;
            }, { total: 0, pending: 0, approved: 0, rejected: 0, cancelled: 0 });

            document.getElementById('total-count').textContent = stats.total;
            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('approved-count').textContent = stats.approved;
            document.getElementById('rejected-count').textContent = stats.rejected;
        }

        function validateForm() {
            const requiredFields = ['user-id', 'leave-type', 'start-date', 'end-date', 'reason'];
            let isValid = true;

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorEl = document.getElementById(`${fieldId}-error`);
                
                if (!field.value.trim()) {
                    errorEl.textContent = 'This field is required';
                    isValid = false;
                }
            });

            // Validate date range
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                document.getElementById('end-date-error').textContent = 'End date must be after start date';
                isValid = false;
            }

            return isValid;
        }

        function updateDurationDisplay() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const durationEl = document.getElementById('duration-display');
            
            if (startDate && endDate) {
                const days = calculateDays(startDate, endDate);
                durationEl.textContent = `${days} day${days !== 1 ? 's' : ''}`;
            } else {
                durationEl.textContent = '0 days';
            }
        }

        // Table Functions
        function renderTable(leaveApplications) {
            filteredData = leaveApplications;
            updateStatistics(leaveApplications);
            
            tableBody.innerHTML = '';
            
            if (!leaveApplications.length) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-4">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <div class="mt-2 text-muted">No leave applications found</div>
                        </td>
                    </tr>`;
                return;
            }

            leaveApplications.forEach(app => {
                const days = calculateDays(app.start_date, app.end_date);
                const statusBadgeClass = getStatusBadgeClass(app.status);
                const isPending = (app.status || '').toLowerCase() === 'pending';
                
                let actionButtons = '';
                if (isPending) {
                    actionButtons = `
                        <div class="btn-group" role="group">
                            <button class="btn btn-success btn-sm" onclick="openStatusModal(${app.id})" title="Process Application">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-info btn-sm" onclick="editLeave(${app.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteLeave(${app.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                } else {
                    actionButtons = `
                        <div class="btn-group" role="group">
                            <button class="btn btn-info btn-sm" onclick="editLeave(${app.id})" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteLeave(${app.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                }

                const reasonText = app.reason && app.reason.length > 50 
                    ? app.reason.substring(0, 50) + '...' 
                    : (app.reason || '');

                const row = `
                    <tr>
                        <td class="fw-bold">${app.id}</td>
                        <td><code>${app.user_id || ''}</code></td>
                        <td><span class="badge bg-light text-dark">${app.leave_type || ''}</span></td>
                        <td>${formatDate(app.start_date)}</td>
                        <td>${formatDate(app.end_date)}</td>
                        <td class="text-center"><span class="badge bg-secondary">${days}</span></td>
                        <td title="${app.reason || ''}">${reasonText}</td>
                        <td><span class="badge ${statusBadgeClass}">${(app.status || '').charAt(0).toUpperCase() + (app.status || '').slice(1)}</span></td>
                        <td class="small text-muted">${formatDateTime(app.applied_date)}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Filter Functions
        function applyFilters() {
            let data = [...allLeaveData];
            
            const status = statusFilter.value;
            const empId = employeeIdFilter.value.trim().toLowerCase();
            const fromDate = fromDateFilter.value;
            const toDate = toDateFilter.value;

            if (status) {
                data = data.filter(app => (app.status || '').toLowerCase() === status.toLowerCase());
            }
            if (empId) {
                data = data.filter(app =>
                    (app.employee_id && app.employee_id.toLowerCase().includes(empId))
                );
            }

            if (fromDate) {
                data = data.filter(app => app.start_date >= fromDate);
            }

            if (toDate) {
                data = data.filter(app => app.end_date <= toDate);
            }

            renderTable(data);
        }

        function clearFilters() {
            statusFilter.value = '';
            employeeIdFilter.value = '';
            fromDateFilter.value = '';
            toDateFilter.value = '';
            renderTable(allLeaveData);
        }

        // API Functions
        async function fetchLeaveApplications() {
            try {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading leave applications...</div>
                        </td>
                    </tr>`;

                const response = await fetch(`${API_BASE_URL}/leave-applications/hr-view/?current_user_id=${CURRENT_USER_ID}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allLeaveData = await response.json();
                renderTable(allLeaveData);
                
            } catch (error) {
                console.error('Error fetching leave applications:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-4 text-danger">
                            <i class="bi bi-exclamation-triangle display-4"></i>
                            <div class="mt-2">Failed to load leave applications</div>
                            <div class="small text-muted">${error.message}</div>
                            <button class="btn btn-outline-primary btn-sm mt-2" onclick="fetchLeaveApplications()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Retry
                            </button>
                        </td>
                    </tr>`;
            }
        }

        async function saveLeaveApplication(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const saveButton = document.getElementById('save-button');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
            saveButton.disabled = true;

            try {
                const id = document.getElementById('leave-id').value;
                const data = {
                    user_id: document.getElementById('user-id').value || null,
                    leave_type: document.getElementById('leave-type').value,
                    start_date: document.getElementById('start-date').value,
                    end_date: document.getElementById('end-date').value,
                    reason: document.getElementById('reason').value,
                    comments: document.getElementById('comments').value || null
                };

                const url = id ? `${API_BASE_URL}/leave-applications/${id}` : `${API_BASE_URL}/leave-applications/`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to save leave application');
                }

                leaveModal.hide();
                await fetchLeaveApplications();
                showNotification(id ? 'Leave application updated successfully!' : 'Leave application created successfully!');
                
            } catch (error) {
                console.error('Error saving leave application:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        async function deleteLeave(id) {
            if (!confirm('Are you sure you want to delete this leave application? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/leave-applications/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete leave application');
                }

                await fetchLeaveApplications();
                showNotification('Leave application deleted successfully!');
                
            } catch (error) {
                console.error('Error deleting leave application:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function saveStatusUpdate(event) {
            event.preventDefault();

            const updateButton = document.querySelector('#status-form button[type="submit"]');
            const originalText = updateButton.innerHTML;
            updateButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Updating...';
            updateButton.disabled = true;

            try {
                const id = document.getElementById('status-leave-id').value;
                const payload = {
                    status: document.getElementById('new-status').value,
                    approved_by: document.getElementById('approved-by').value,
                    comments: document.getElementById('status-comments').value || null
                };

                const response = await fetch(`${API_BASE_URL}/leave-applications/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to update status');
                }

                statusModal.hide();
                await fetchLeaveApplications();
                showNotification('Leave status updated successfully!');
                
            } catch (error) {
                console.error('Error updating status:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                updateButton.innerHTML = originalText;
                updateButton.disabled = false;
            }
        }

        // Modal Functions
        function editLeave(id) {
            const app = allLeaveData.find(x => x.id == id);
            if (!app) {
                showNotification('Leave application not found', 'error');
                return;
            }

            // Set modal title based on status
            const isPending = (app.status || '').toLowerCase() === 'pending';
            document.getElementById('leaveModalLabel').textContent = isPending ? 'Edit Leave Application' : 'View Leave Application';
            
            // Fill form fields
            document.getElementById('leave-id').value = app.id;
            document.getElementById('user-id').value = app.user_id || '';
            document.getElementById('employee-id').value = app.employee_id || '';
            document.getElementById('leave-type').value = app.leave_type || '';
            document.getElementById('start-date').value = app.start_date || '';
            document.getElementById('end-date').value = app.end_date || '';
            document.getElementById('reason').value = app.reason || '';
            document.getElementById('comments').value = app.comments || '';
            
            // Update duration display
            updateDurationDisplay();
            
            // Disable form if not pending (for view-only)
            const formElements = document.querySelectorAll('#leave-form input, #leave-form select, #leave-form textarea');
            formElements.forEach(element => {
                element.disabled = !isPending;
            });
            
            // Update save button
            const saveButton = document.getElementById('save-button');
            if (isPending) {
                saveButton.style.display = 'inline-block';
                saveButton.innerHTML = '<i class="bi bi-check-circle me-1"></i>Update Application';
            } else {
                saveButton.style.display = 'none';
            }
            
            leaveModal.show();
        }

        function openStatusModal(id) {
            const app = allLeaveData.find(x => x.id == id);
            if (!app) {
                showNotification('Leave application not found', 'error');
                return;
            }

            document.getElementById('status-leave-id').value = id;
            
            // Populate application details
            const detailsHtml = `
                <div class="row">
                    <div class="col-md-6"><strong>User ID:</strong> ${app.user_id}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6"><strong>Leave Type:</strong> ${app.leave_type}</div>
                    <div class="col-md-6"><strong>Duration:</strong> ${calculateDays(app.start_date, app.end_date)} days</div>
                </div>
                <div class="row mt-2">
                    <div class="col-12"><strong>Dates:</strong> ${formatDate(app.start_date)} to ${formatDate(app.end_date)}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-12"><strong>Reason:</strong> ${app.reason}</div>
                </div>
            `;
            document.getElementById('status-app-details').innerHTML = detailsHtml;
            
            // Reset form
            document.getElementById('new-status').value = '';
            document.getElementById('approved-by').value = 'HR Manager';
            document.getElementById('status-comments').value = '';
            
            statusModal.show();
        }

        function resetLeaveForm() {
            leaveForm.reset();
            document.getElementById('leave-id').value = '';
            document.getElementById('leaveModalLabel').textContent = 'Add Leave Application';
            
            // Clear error messages
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            
            // Enable all form elements
            const formElements = document.querySelectorAll('#leave-form input, #leave-form select, #leave-form textarea');
            formElements.forEach(element => {
                element.disabled = false;
            });
            
            // Reset save button
            const saveButton = document.getElementById('save-button');
            saveButton.style.display = 'inline-block';
            saveButton.innerHTML = '<i class="bi bi-check-circle me-1"></i>Save Application';
            
            // Reset duration display
            document.getElementById('duration-display').textContent = '0 days';
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').min = today;
            document.getElementById('end-date').min = today;
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initial data load
            fetchLeaveApplications();
            
            // Filter event listeners
            statusFilter.addEventListener('change', applyFilters);
            employeeIdFilter.addEventListener('input', debounce(applyFilters, 300));
            fromDateFilter.addEventListener('change', applyFilters);
            toDateFilter.addEventListener('change', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);
            
            // Form event listeners
            leaveForm.addEventListener('submit', saveLeaveApplication);
            statusForm.addEventListener('submit', saveStatusUpdate);
            
            // Modal event listeners
            addNewBtn.addEventListener('click', resetLeaveForm);
            
            // Date change listeners for duration calculation
            document.getElementById('start-date').addEventListener('change', function() {
                updateDurationDisplay();
                // Update end date minimum
                const startDate = this.value;
                if (startDate) {
                    document.getElementById('end-date').min = startDate;
                }
            });
            
            document.getElementById('end-date').addEventListener('change', updateDurationDisplay);
            
            // Set initial minimum dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').min = today;
            document.getElementById('end-date').min = today;
        });

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + N for new application
            if ((event.ctrlKey || event.metaKey) && event.key === 'n' && !event.target.matches('input, textarea')) {
                event.preventDefault();
                addNewBtn.click();
            }
            
            // Escape to close modals
            if (event.key === 'Escape') {
                // Bootstrap handles this automatically, but we can add custom logic here if needed
            }
        });

        // Auto-refresh data every 5 minutes
        setInterval(fetchLeaveApplications, 5 * 60 * 1000);

        // Export functions for global access
        window.editLeave = editLeave;
        window.openStatusModal = openStatusModal;
        window.deleteLeave = deleteLeave;
        window.fetchLeaveApplications = fetchLeaveApplications;
    </script>

{% endblock %}
