{% extends "admin/base.html" %}

{% block title %}Background Check Forms{% endblock %}

{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Check Form Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-actions .btn {
            margin: 0 2px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            display: none;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.875rem;
            z-index: 1000;
        }
        .connection-online {
            background-color: #28a745;
            color: white;
        }
        .connection-offline {
            background-color: #dc3545;
            color: white;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .birthday-alert {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .form-section {
            border-left: 3px solid #007bff;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .draft-indicator {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
            font-weight: bold;
        }
        .form-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .form-details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status connection-offline" id="connection-status">
        <i class="bi bi-wifi-off"></i> Connecting...
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <div class="container-fluid mt-4">
        <!-- Birthday Alert -->
        <div class="row mb-3" id="birthday-alert" style="display: none;">
            <div class="col-12">
                <div class="alert alert-info birthday-alert">
                    <i class="bi bi-gift"></i>
                    <span id="birthday-message"></span>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Forms</h5>
                        <h2 id="total-forms">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">Pending</h5>
                        <h2 id="pending-forms">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">Approved</h5>
                        <h2 id="approved-forms">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">Rejected</h5>
                        <h2 id="rejected-forms">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drafts Section -->
        <div class="card mb-4">
            <div class="card-header card-header-flex draft-indicator">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-earmark-text"></i> Draft Forms
                </h5>
                <button class="btn btn-light btn-sm" id="refresh-drafts-btn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Drafts
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Candidate Name</th>
                                <th>Email</th>
                                <th>Contact</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="drafts-table-body">
                            <tr>
                                <td colspan="7" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    Loading drafts...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Main Forms Management -->
        <div class="card">
            <div class="card-header card-header-flex">
                <h3 class="card-title mb-0">
                    <i class="bi bi-file-person"></i> Background Check Forms Management
                </h3>
                <div class="btn-group">
                    <button class="btn btn-primary" id="check-birthdays-btn">
                        <i class="bi bi-gift"></i> Check Birthdays
                    </button>
                    <button class="btn btn-secondary" id="refresh-btn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filters and Search -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="search-input" class="form-control" placeholder="Search by name or email...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="status-filter" class="form-select">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="email" id="email-search" class="form-control" placeholder="Search by email">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" id="email-search-btn">
                            <i class="bi bi-person-search"></i> Find Profile
                        </button>
                    </div>
                </div>

                <!-- Forms Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-hash"></i> ID</th>
                                <th><i class="bi bi-person"></i> Candidate</th>
                                <th><i class="bi bi-envelope"></i> Email</th>
                                <th><i class="bi bi-phone"></i> Contact</th>
                                <th><i class="bi bi-calendar"></i> Submitted</th>
                                <th><i class="bi bi-flag"></i> Status</th>
                                <th class="text-center"><i class="bi bi-gear"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="forms-table-body">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading forms...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Forms pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Form Details Modal -->
    <div class="modal fade" id="formDetailsModal" tabindex="-1" aria-labelledby="formDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="formDetailsModalLabel">
                        <i class="bi bi-file-earmark-text"></i> Form Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="form-details-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approvalModalLabel">
                        <i class="bi bi-check-circle"></i> Form Approval
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="approval-form">
                        <input type="hidden" id="approval-form-id">
                        <div class="mb-3">
                            <label class="form-label">Action</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="action" id="approve-radio" value="approve">
                                    <label class="form-check-label text-success" for="approve-radio">
                                        <i class="bi bi-check-circle"></i> Approve
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="action" id="reject-radio" value="reject">
                                    <label class="form-check-label text-danger" for="reject-radio">
                                        <i class="bi bi-x-circle"></i> Reject
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="approval-remarks" class="form-label">Remarks</label>
                            <textarea class="form-control" id="approval-remarks" rows="3" placeholder="Optional remarks for approval/rejection..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" form="approval-form" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Submit Decision
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Draft Details Modal -->
    <div class="modal fade" id="draftDetailsModal" tabindex="-1" aria-labelledby="draftDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header draft-indicator">
                    <h5 class="modal-title" id="draftDetailsModalLabel">
                        <i class="bi bi-file-earmark-text"></i> Draft Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="draft-details-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class BackgroundCheckAdminApp {
            constructor() {
                this.API_BASE_URL = "{{ API_BASE_URL }}/api/background-check";
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.totalItems = 0;
                this.allForms = [];
                this.filteredForms = [];
                this.drafts = [];
                
                this.initializeElements();
                this.attachEventListeners();
                this.initialize();
            }

            initializeElements() {
                // Modal elements
                this.formDetailsModal = new bootstrap.Modal(document.getElementById('formDetailsModal'));
                this.approvalModal = new bootstrap.Modal(document.getElementById('approvalModal'));
                this.draftDetailsModal = new bootstrap.Modal(document.getElementById('draftDetailsModal'));
                
                // Form elements
                this.tableBody = document.getElementById('forms-table-body');
                this.draftsTableBody = document.getElementById('drafts-table-body');
                this.searchInput = document.getElementById('search-input');
                this.statusFilter = document.getElementById('status-filter');
                this.emailSearch = document.getElementById('email-search');
                this.emailSearchBtn = document.getElementById('email-search-btn');
                this.approvalForm = document.getElementById('approval-form');
                this.refreshBtn = document.getElementById('refresh-btn');
                this.refreshDraftsBtn = document.getElementById('refresh-drafts-btn');
                this.checkBirthdaysBtn = document.getElementById('check-birthdays-btn');
                this.loadingOverlay = document.getElementById('loading-overlay');
                this.connectionStatus = document.getElementById('connection-status');
                this.pagination = document.getElementById('pagination');

                // Stats elements
                this.totalFormsEl = document.getElementById('total-forms');
                this.pendingFormsEl = document.getElementById('pending-forms');
                this.approvedFormsEl = document.getElementById('approved-forms');
                this.rejectedFormsEl = document.getElementById('rejected-forms');
                
                // Birthday elements
                this.birthdayAlert = document.getElementById('birthday-alert');
                this.birthdayMessage = document.getElementById('birthday-message');
            }

            attachEventListeners() {
                // Search and filter events
                this.searchInput.addEventListener('input', this.debounce(() => this.applyFilters(), 300));
                this.statusFilter.addEventListener('change', () => this.applyFilters());
                this.emailSearchBtn.addEventListener('click', () => this.searchByEmail());
                this.emailSearch.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.searchByEmail();
                });
                this.refreshBtn.addEventListener('click', () => this.initialize());
                this.refreshDraftsBtn.addEventListener('click', () => this.fetchDrafts());
                this.checkBirthdaysBtn.addEventListener('click', () => this.checkTodaysBirthdays());
                
                // Form events
                this.approvalForm.addEventListener('submit', (e) => this.handleApprovalSubmit(e));
                
                // Table events
                this.tableBody.addEventListener('click', (e) => this.handleTableActions(e));
                this.draftsTableBody.addEventListener('click', (e) => this.handleDraftActions(e));
            }

            async initialize() {
                this.showLoading();
                try {
                    await this.checkHealthStatus();
                    await Promise.all([
                        this.fetchForms(),
                        this.fetchDrafts(),
                        this.fetchStats()
                    ]);
                    this.updateConnectionStatus(true);
                    this.showToast('Connected to database successfully!', 'success');
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.updateConnectionStatus(false);
                    this.showToast('Failed to connect to database. Please check your connection.', 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            async checkHealthStatus() {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/health`);
                    if (!response.ok) throw new Error('Health check failed');
                    return await response.json();
                } catch (error) {
                    console.error('Health check error:', error);
                    throw error;
                }
            }

            async fetchForms() {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/forms`);
                    if (!response.ok) throw new Error('Failed to fetch forms');
                    
                    this.allForms = await response.json();
                    this.applyFilters();
                } catch (error) {
                    console.error('Error fetching forms:', error);
                    this.tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger py-4">
                                <i class="bi bi-exclamation-triangle"></i>
                                <div class="mt-2">Error loading forms. Please check your connection.</div>
                            </td>
                        </tr>`;
                    throw error;
                }
            }

            async fetchDrafts() {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/drafts`);
                    if (!response.ok) throw new Error('Failed to fetch drafts');
                    
                    this.drafts = await response.json();
                    this.renderDraftsTable();
                } catch (error) {
                    console.error('Error fetching drafts:', error);
                    this.draftsTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger py-3">
                                <i class="bi bi-exclamation-triangle"></i>
                                Error loading drafts.
                            </td>
                        </tr>`;
                }
            }

            async fetchStats() {
                try {
                    const [pendingRes, approvedRes, rejectedRes] = await Promise.all([
                        fetch(`${this.API_BASE_URL}/forms/pending`),
                        fetch(`${this.API_BASE_URL}/forms/approved`),
                        fetch(`${this.API_BASE_URL}/forms/rejected`)
                    ]);

                    const [pending, approved, rejected] = await Promise.all([
                        pendingRes.json(),
                        approvedRes.json(),
                        rejectedRes.json()
                    ]);

                    this.totalFormsEl.textContent = this.allForms.length;
                    this.pendingFormsEl.textContent = pending.length;
                    this.approvedFormsEl.textContent = approved.length;
                    this.rejectedFormsEl.textContent = rejected.length;
                } catch (error) {
                    console.error('Error fetching stats:', error);
                }
            }

            async checkTodaysBirthdays() {
                try {
                    this.showLoading();
                    const response = await fetch(`${this.API_BASE_URL}/users/birthdays/today`);
                    if (!response.ok) throw new Error('Failed to fetch birthday data');
                    
                    const data = await response.json();
                    
                    if (data.total_birthdays > 0) {
                        const names = data.birthday_users.map(user => user.candidate_name).join(', ');
                        this.birthdayMessage.textContent = `Today's Birthdays (${data.total_birthdays}): ${names}`;
                        this.birthdayAlert.style.display = 'block';
                        this.showToast(`Found ${data.total_birthdays} birthday(s) today!`, 'info');
                    } else {
                        this.birthdayAlert.style.display = 'none';
                        this.showToast('No birthdays today.', 'info');
                    }
                } catch (error) {
                    console.error('Error checking birthdays:', error);
                    this.showToast('Error checking birthdays.', 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            applyFilters() {
                const search = this.searchInput.value.toLowerCase();
                const status = this.statusFilter.value;

                this.filteredForms = this.allForms.filter(form => {
                    const matchesSearch = !search || 
                        form.candidate_name?.toLowerCase().includes(search) || 
                        form.email_id?.toLowerCase().includes(search);
                    
                    const matchesStatus = !status || form.status === status;

                    return matchesSearch && matchesStatus;
                });

                this.currentPage = 1;
                this.renderTable();
                this.renderPagination();
            }

            renderTable() {
                if (this.filteredForms.length === 0) {
                    this.tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-inbox"></i>
                                <div class="mt-2">No forms found matching your criteria.</div>
                            </td>
                        </tr>`;
                    return;
                }

                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const currentForms = this.filteredForms.slice(startIndex, endIndex);

                this.tableBody.innerHTML = '';
                currentForms.forEach(form => {
                    const statusBadge = this.getStatusBadge(form.status);
                    const createdDate = new Date(form.created_at).toLocaleDateString();
                    
                    const row = `
                        <tr>
                            <td><strong>#${form.id}</strong></td>
                            <td>
                                <div class="fw-bold">${this.escapeHtml(form.candidate_name || 'N/A')}</div>
                            </td>
                            <td>${this.escapeHtml(form.email_id || 'N/A')}</td>
                            <td>${form.contact_number || 'N/A'}</td>
                            <td>${createdDate}</td>
                            <td>${statusBadge}</td>
                            <td class="text-center table-actions">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info view-btn" data-id="${form.id}" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    ${form.status === 'pending' ? `
                                        <button class="btn btn-sm btn-outline-success approve-btn" data-id="${form.id}" title="Approve/Reject">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${form.id}" title="Delete Form">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    this.tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            renderDraftsTable() {
                if (this.drafts.length === 0) {
                    this.draftsTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-3">
                                <i class="bi bi-inbox"></i>
                                No drafts found.
                            </td>
                        </tr>`;
                    return;
                }

                this.draftsTableBody.innerHTML = '';
                this.drafts.forEach(draft => {
                    const createdDate = new Date(draft.created_at).toLocaleDateString();
                    const updatedDate = new Date(draft.updated_at).toLocaleDateString();
                    
                    const row = `
                        <tr>
                            <td><strong>#${draft.id}</strong></td>
                            <td>${this.escapeHtml(draft.candidate_name || 'N/A')}</td>
                            <td>${this.escapeHtml(draft.email_id || 'N/A')}</td>
                            <td>${draft.contact_number || 'N/A'}</td>
                            <td>${createdDate}</td>
                            <td>${updatedDate}</td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info view-draft-btn" data-email="${draft.email_id}" title="View Draft">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-draft-btn" data-id="${draft.id}" title="Delete Draft">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    this.draftsTableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredForms.length / this.itemsPerPage);
                
                if (totalPages <= 1) {
                    this.pagination.innerHTML = '';
                    return;
                }

                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${this.currentPage - 1}">Previous</a>
                    </li>`;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        paginationHTML += `
                            <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>`;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }

                // Next button
                paginationHTML += `
                    <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${this.currentPage + 1}">Next</a>
                    </li>`;

                this.pagination.innerHTML = paginationHTML;
                
                // Add click event listeners to pagination links
                this.pagination.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(e.target.getAttribute('data-page'));
                    if (page && page !== this.currentPage && page >= 1 && page <= totalPages) {
                        this.currentPage = page;
                        this.renderTable();
                        this.renderPagination();
                    }
                });
            }

            getStatusBadge(status) {
                const badges = {
                    'pending': '<span class="badge bg-warning status-badge">Pending</span>',
                    'approved': '<span class="badge bg-success status-badge">Approved</span>',
                    'rejected': '<span class="badge bg-danger status-badge">Rejected</span>',
                    'draft': '<span class="badge bg-secondary status-badge">Draft</span>'
                };
                return badges[status] || '<span class="badge bg-light text-dark status-badge">Unknown</span>';
            }

            async searchByEmail() {
                const email = this.emailSearch.value.trim();
                if (!email) {
                    this.showToast('Please enter an email address to search.', 'warning');
                    return;
                }

                this.showLoading();
                try {
                    const response = await fetch(`${this.API_BASE_URL}/profile/${encodeURIComponent(email)}`);
                    if (response.status === 404) {
                        this.showToast('No profile found for this email address.', 'warning');
                        return;
                    }
                    if (!response.ok) throw new Error('Failed to fetch profile');
                    
                    const profile = await response.json();
                    this.showFormDetails(profile, 'Profile Details');
                } catch (error) {
                    console.error('Error searching profile:', error);
                    this.showToast('Error searching for profile.', 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            async handleTableActions(e) {
                const target = e.target.closest('button');
                if (!target) return;
                
                const id = target.dataset.id;
                
                if (target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this form? This action cannot be undone.')) {
                        await this.deleteForm(id);
                    }
                } else if (target.classList.contains('view-btn')) {
                    await this.viewFormDetails(id);
                } else if (target.classList.contains('approve-btn')) {
                    this.openApprovalModal(id);
                }
            }

            async handleDraftActions(e) {
                const target = e.target.closest('button');
                if (!target) return;
                
                if (target.classList.contains('delete-draft-btn')) {
                    const id = target.dataset.id;
                    if (confirm('Are you sure you want to delete this draft?')) {
                        await this.deleteDraft(id);
                    }
                } else if (target.classList.contains('view-draft-btn')) {
                    const email = target.dataset.email;
                    await this.viewDraftDetails(email);
                }
            }

            async deleteForm(id) {
                this.showLoading();
                try {
                    const response = await fetch(`${this.API_BASE_URL}/form/${id}`, { 
                        method: 'DELETE' 
                    });
                    
                    if (!response.ok) throw new Error('Failed to delete form');
                    
                    await this.fetchForms();
                    await this.fetchStats();
                    this.showToast('Form deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting form:', error);
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            async deleteDraft(id) {
                this.showLoading();
                try {
                    const response = await fetch(`${this.API_BASE_URL}/draft/${id}`, { 
                        method: 'DELETE' 
                    });
                    
                    if (!response.ok) throw new Error('Failed to delete draft');
                    
                    await this.fetchDrafts();
                    this.showToast('Draft deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting draft:', error);
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            async viewFormDetails(id) {
                try {
                    this.showLoading();
                    const response = await fetch(`${this.API_BASE_URL}/form/${id}`);
                    if (!response.ok) throw new Error('Form not found');
                    
                    const form = await response.json();
                    this.showFormDetails(form, 'Form Details');
                } catch (error) {
                    console.error('Error fetching form details:', error);
                    this.showToast('Could not load form details', 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            async viewDraftDetails(email) {
                try {
                    this.showLoading();
                    const response = await fetch(`${this.API_BASE_URL}/get-draft/${encodeURIComponent(email)}`);
                    if (response.status === 404) {
                        this.showToast('Draft not found for this email.', 'warning');
                        return;
                    }
                    if (!response.ok) throw new Error('Draft not found');
                    
                    const draft = await response.json();
                    this.showDraftDetails(draft);
                } catch (error) {
                    console.error('Error fetching draft details:', error);
                    this.showToast('Could not load draft details', 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            showFormDetails(form, title = 'Form Details') {
                document.getElementById('formDetailsModalLabel').innerHTML = `<i class="bi bi-file-earmark-text"></i> ${title} - ${this.escapeHtml(form.candidate_name || 'N/A')}`;
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '<span class="text-muted">Not specified</span>';
                    return new Date(dateStr).toLocaleDateString();
                };

                const formatArray = (arr) => {
                    if (!arr || arr.length === 0) return '<span class="text-muted">None</span>';
                    return JSON.stringify(arr, null, 2);
                };

                document.getElementById('form-details-content').innerHTML = `
                    <div class="form-details-grid">
                        <!-- Personal Information -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-person"></i> Personal Information</h6>
                            <p><strong>Candidate Name:</strong> ${this.escapeHtml(form.candidate_name || 'N/A')}</p>
                            <p><strong>Father's Name:</strong> ${this.escapeHtml(form.father_name || 'N/A')}</p>
                            <p><strong>Mother's Name:</strong> ${this.escapeHtml(form.mother_name || 'N/A')}</p>
                            <p><strong>Date of Birth:</strong> ${formatDate(form.date_of_birth)}</p>
                            <p><strong>Marital Status:</strong> ${this.escapeHtml(form.marital_status || 'N/A')}</p>
                            <p><strong>Email:</strong> ${this.escapeHtml(form.email_id || 'N/A')}</p>
                            <p><strong>Contact:</strong> ${form.contact_number || 'N/A'}</p>
                            <p><strong>Alternate Contact:</strong> ${form.alternate_contact_number || 'N/A'}</p>
                            <p><strong>Aadhaar:</strong> ${form.aadhaar_card_number || 'N/A'}</p>
                            <p><strong>PAN:</strong> ${this.escapeHtml(form.pan_number || 'N/A')}</p>
                            <p><strong>UAN:</strong> ${form.uan_number || 'N/A'}</p>
                        </div>

                        <!-- Current Address -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-geo-alt"></i> Current Address</h6>
                            <p><strong>Complete Address:</strong> ${this.escapeHtml(form.current_complete_address || 'N/A')}</p>
                            <p><strong>Landmark:</strong> ${this.escapeHtml(form.current_landmark || 'N/A')}</p>
                            <p><strong>City:</strong> ${this.escapeHtml(form.current_city || 'N/A')}</p>
                            <p><strong>State:</strong> ${this.escapeHtml(form.current_state || 'N/A')}</p>
                            <p><strong>PIN Code:</strong> ${form.current_pin_code || 'N/A'}</p>
                            <p><strong>Police Station:</strong> ${this.escapeHtml(form.current_police_station || 'N/A')}</p>
                            <p><strong>Duration From:</strong> ${formatDate(form.current_duration_from)}</p>
                            <p><strong>Duration To:</strong> ${formatDate(form.current_duration_to)}</p>
                        </div>

                        <!-- Permanent Address -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-house"></i> Permanent Address</h6>
                            <p><strong>Complete Address:</strong> ${this.escapeHtml(form.permanent_complete_address || 'N/A')}</p>
                            <p><strong>Landmark:</strong> ${this.escapeHtml(form.permanent_landmark || 'N/A')}</p>
                            <p><strong>City:</strong> ${this.escapeHtml(form.permanent_city || 'N/A')}</p>
                            <p><strong>State:</strong> ${this.escapeHtml(form.permanent_state || 'N/A')}</p>
                            <p><strong>PIN Code:</strong> ${form.permanent_pin_code || 'N/A'}</p>
                            <p><strong>Police Station:</strong> ${this.escapeHtml(form.permanent_police_station || 'N/A')}</p>
                            <p><strong>Duration From:</strong> ${formatDate(form.permanent_duration_from)}</p>
                            <p><strong>Duration To:</strong> ${formatDate(form.permanent_duration_to)}</p>
                        </div>

                        <!-- Employment Details -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-building"></i> Employment Details</h6>
                            <p><strong>Organization:</strong> ${this.escapeHtml(form.organization_name || 'N/A')}</p>
                            <p><strong>Organization Address:</strong> ${this.escapeHtml(form.organization_address || 'N/A')}</p>
                            <p><strong>Designation:</strong> ${this.escapeHtml(form.designation || 'N/A')}</p>
                            <p><strong>Employee Code:</strong> ${this.escapeHtml(form.employee_code || 'N/A')}</p>
                            <p><strong>Date of Joining:</strong> ${formatDate(form.date_of_joining)}</p>
                            <p><strong>Last Working Day:</strong> ${formatDate(form.last_working_day)}</p>
                            <p><strong>Salary:</strong> ${form.salary ? '₹' + form.salary.toLocaleString() : 'N/A'}</p>
                            <p><strong>Reason for Leaving:</strong> ${this.escapeHtml(form.reason_for_leaving || 'N/A')}</p>
                        </div>

                        <!-- Manager Details -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-person-badge"></i> Manager Details</h6>
                            <p><strong>Manager Name:</strong> ${this.escapeHtml(form.manager_name || 'N/A')}</p>
                            <p><strong>Manager Contact:</strong> ${form.manager_contact_number || 'N/A'}</p>
                            <p><strong>Manager Email:</strong> ${this.escapeHtml(form.manager_email_id || 'N/A')}</p>
                        </div>

                        <!-- Form Status -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-info-circle"></i> Form Status</h6>
                            <p><strong>Status:</strong> ${this.getStatusBadge(form.status)}</p>
                            <p><strong>Created:</strong> ${formatDate(form.created_at)}</p>
                            <p><strong>Updated:</strong> ${formatDate(form.updated_at)}</p>
                            <p><strong>Processed:</strong> ${formatDate(form.processed_at)}</p>
                            ${form.remarks ? `<p><strong>Remarks:</strong> ${this.escapeHtml(form.remarks)}</p>` : ''}
                        </div>
                    </div>

                    <!-- JSON Data Sections -->
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6 class="text-secondary"><i class="bi bi-mortarboard"></i> Education Details</h6>
                                <div class="json-display">${formatArray(form.education_details)}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6 class="text-secondary"><i class="bi bi-people"></i> HR Details</h6>
                                <div class="json-display">${formatArray(form.hr_details)}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6 class="text-secondary"><i class="bi bi-person-lines-fill"></i> Reference Details</h6>
                                <div class="json-display">${formatArray(form.reference_details)}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6 class="text-secondary"><i class="bi bi-check-square"></i> Verification Checks</h6>
                                <div class="json-display">${JSON.stringify(form.verification_checks || {}, null, 2)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Authorization Section -->
                    <div class="mt-3">
                        <h6 class="text-secondary"><i class="bi bi-pen"></i> Authorization</h6>
                        <div class="form-section">
                            <p><strong>Candidate Name (Auth):</strong> ${this.escapeHtml(form.candidate_name_auth || 'N/A')}</p>
                            <p><strong>Signature:</strong> ${this.escapeHtml(form.signature || 'N/A')}</p>
                            <p><strong>Auth Date:</strong> ${formatDate(form.auth_date)}</p>
                            <p><strong>Acknowledgment:</strong> ${form.acknowledgment ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                `;

                this.formDetailsModal.show();
            }

            showDraftDetails(draft) {
                document.getElementById('draftDetailsModalLabel').innerHTML = `<i class="bi bi-file-earmark-text"></i> Draft Details - ${this.escapeHtml(draft.candidate_name || 'N/A')}`;
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '<span class="text-muted">Not specified</span>';
                    return new Date(dateStr).toLocaleDateString();
                };

                const formatArray = (arr) => {
                    if (!arr || arr.length === 0) return '<span class="text-muted">None</span>';
                    return JSON.stringify(arr, null, 2);
                };

                document.getElementById('draft-details-content').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> This is a draft form that has not been submitted yet.
                    </div>
                    
                    <div class="form-details-grid">
                        <!-- Personal Information -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-person"></i> Personal Information</h6>
                            <p><strong>Candidate Name:</strong> ${this.escapeHtml(draft.candidate_name || 'N/A')}</p>
                            <p><strong>Email:</strong> ${this.escapeHtml(draft.email_id || 'N/A')}</p>
                            <p><strong>Contact:</strong> ${draft.contact_number || 'N/A'}</p>
                            <p><strong>Date of Birth:</strong> ${formatDate(draft.date_of_birth)}</p>
                        </div>

                        <!-- Draft Status -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="bi bi-info-circle"></i> Draft Information</h6>
                            <p><strong>Draft ID:</strong> #${draft.id}</p>
                            <p><strong>Status:</strong> ${this.getStatusBadge(draft.status)}</p>
                            <p><strong>Created:</strong> ${formatDate(draft.created_at)}</p>
                            <p><strong>Last Updated:</strong> ${formatDate(draft.updated_at)}</p>
                        </div>
                    </div>

                    <!-- Additional draft data can be displayed here -->
                    <div class="mt-3">
                        <p class="text-muted"><i class="bi bi-lightbulb"></i> Complete draft data is available through the API for editing purposes.</p>
                    </div>
                `;

                this.draftDetailsModal.show();
            }

            openApprovalModal(id) {
                document.getElementById('approval-form-id').value = id;
                document.getElementById('approval-remarks').value = '';
                document.querySelector('input[name="action"]:checked')?.click();
                this.approvalModal.show();
            }

            async handleApprovalSubmit(e) {
                e.preventDefault();
                
                const formId = document.getElementById('approval-form-id').value;
                const action = document.querySelector('input[name="action"]:checked')?.value;
                const remarks = document.getElementById('approval-remarks').value.trim();

                if (!action) {
                    this.showToast('Please select an action (Approve or Reject).', 'warning');
                    return;
                }

                this.showLoading();
                try {
                    const response = await fetch(`${this.API_BASE_URL}/form/${formId}/approve`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: action,
                            remarks: remarks || null
                        })
                    });

                    if (!response.ok) throw new Error('Failed to process approval');
                    
                    const result = await response.json();
                    this.approvalModal.hide();
                    await this.fetchForms();
                    await this.fetchStats();
                    this.showToast(`Form ${action}d successfully!`, 'success');
                } catch (error) {
                    console.error('Error processing approval:', error);
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    this.hideLoading();
                }
            }

            // Utility methods
            showLoading() {
                this.loadingOverlay.style.display = 'flex';
            }

            hideLoading() {
                this.loadingOverlay.style.display = 'none';
            }

            updateConnectionStatus(isOnline) {
                this.connectionStatus.className = `connection-status ${isOnline ? 'connection-online' : 'connection-offline'}`;
                this.connectionStatus.innerHTML = isOnline ? 
                    '<i class="bi bi-wifi"></i> Connected' : 
                    '<i class="bi bi-wifi-off"></i> Disconnected';
            }

            showToast(message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container');
                const toastId = `toast-${Date.now()}`;
                
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-bg-${type} border-0`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                toast.setAttribute('id', toastId);
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-${this.getToastIcon(type)}"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                                data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
                bsToast.show();
                
                // Clean up after toast is hidden
                toast.addEventListener('hidden.bs.toast', () => {
                    toast.remove();
                });
            }

            getToastIcon(type) {
                const icons = {
                    'success': 'check-circle',
                    'danger': 'exclamation-triangle',
                    'warning': 'exclamation-circle',
                    'info': 'info-circle'
                };
                return icons[type] || icons['info'];
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.backgroundCheckAdmin = new BackgroundCheckAdminApp();
        });

        // Add periodic connection check
        setInterval(() => {
            if (window.backgroundCheckAdmin) {
                fetch(`${window.backgroundCheckAdmin.API_BASE_URL}/health`)
                    .then(response => {
                        window.backgroundCheckAdmin.updateConnectionStatus(response.ok);
                    })
                    .catch(() => {
                        window.backgroundCheckAdmin.updateConnectionStatus(false);
                    });
            }
        }, 30000); // Check every 30 seconds
    </script>
{% endblock %}